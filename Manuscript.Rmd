---
title: Contrasting influences of topography and canopy height on the functional assembly of canopy and understory tree guilds in an Indian rainforest
output:
  bookdown::word_document2:
    reference_docx: ./template/template.docx
  bookdown::pdf_document2:
    includes:
      before_body: ./template/doc_prefix.tex
      in_header: ./template/preamble.tex
    number_sections: false
    toc: false
  bookdown::html_document2:
    number_sections: false  
    toc: true
    toc_float: yes
linestretch: 1.5
csl: /home/sylvain/Documents/Bibliography/csl/journal-of-vegetation-science.csl
bibliography: /home/sylvain/Documents/Bibliography/library.bib
link-citations: yes
---

```{r config, message=FALSE, warning=FALSE, include=FALSE}
rm(list = ls()); invisible(gc())
library(raster)
library(parallel)
library(knitr)
library(kableExtra)
if(knitr:::is_html_output()) options(knitr.table.format = "html") 
if(knitr:::is_latex_output()) options(knitr.table.format = "latex") 
library(tidyverse)
library(broom)
library(reshape2)
library(ggfortify)
library(rstan)
options(mc.cores = 4)
rstan_options(auto_write = T)
library(bayesplot)
theme_set(bayesplot::theme_default())
opts_chunk$set(echo = F, message = F, warning = F, 
               fig.height = 8, fig.width = 8,
               cache = T, cache.lazy = F)
cv <- function(x, na.rm = T)
  sd(x, na.rm = na.rm)/mean(x, na.rm = na.rm)
n = 999 # Random repetitions
sapply(list.files("R", full.names = T), source)
```

```{r data, include = F}
# Sp level PFT
PFT <- genPFT() %>% 
  mutate(LA = log(LA)) %>% 
  mutate(SLA = log(SLA)) %>% 
  select(-CE) %>% 
  group_by(Tree, Sp, SpCode) %>% 
  summarise_all(funs(mean(., na.rm = T))) %>% 
  ungroup() %>% 
  select(-Tree) %>% 
  group_by(Sp, SpCode) %>% 
  summarise_all(funs(mean(., na.rm = T))) %>% 
  ungroup() %>% 
  select(-LTD, -SHA, -Sp)
# PCA
PFT.pca <- princomp(~ LA + WD + LT + LDMC + SLA, data = PFT, cor = T)
# Matrix Q
PFT <- PFT %>% 
  mutate(SpCode = as.character(SpCode)) %>% 
  left_join(genSpecies(), by = "SpCode") %>% 
  mutate(strata = ifelse(Strata == 3, "U", "C")) %>%
  mutate(strata = ifelse(SpCode == "agin", "U", strata)) %>% 
  dplyr::select(strata, SpCode, LA, WD, LT, LDMC, SLA) %>% 
  reshape2::melt(id.vars = c("strata", "SpCode"), 
                 variable.name = "trait", value.name = "traitvalue")
# Matrix L
com <- quadrats(cs = c(30,30))
XY <- genTrees()[c('x', 'y')]
coordinates(XY) <- ~ x + y
proj4string(XY) <- crs(com)
trees <- genTrees() %>% 
  mutate(community = (XY %over% com)[,1]) %>% 
  filter(!is.na(community)) %>% 
  group_by(community, SpCode) %>% 
  summarise(Abundance = n())
# Matrix R
load(file.path("draft_save", 'R.Rdata'))
# GWM
GWM <- trees %>% 
  left_join(PFT) %>% 
  filter(!is.na(strata)) %>% 
  group_by(strata, community, trait) %>% 
  summarise(GWM = weighted.mean(traitvalue, Abundance, na.rm = T))
# GWM plot
left_join(GWM, R) %>% 
  reshape2::melt(id.vars = c("strata", "community", "trait", "GWM")) %>% 
  filter(variable != "BA") %>% 
  ggplot(aes(value, GWM, col = strata)) +
  facet_grid(trait ~ variable, scales = "free") +
  geom_point() +
  geom_smooth(method = "lm") +
  theme(legend.position = "bottom", axis.title = element_blank())
# nGWM
nGWM <- lapply(1:n, function(n) 
  left_join(trees, 
            group_by(PFT, trait, strata) %>% 
              mutate(SpCode = sample(SpCode)),
            by = "SpCode") %>% 
    filter(!is.na(strata)) %>% 
    group_by(strata, community, trait) %>% 
    summarise(nGWM = weighted.mean(traitvalue, Abundance, na.rm = T)) %>% 
    mutate(NullModel = n)) %>% 
  bind_rows()
# nGWM plot
# ggplot(nGWM, aes(nGWM, col = community), fill = NA) +
#   geom_density(alpha = .5) +
#   facet_wrap(~ strata + trait, scales = "free") +
#   scale_color_discrete(guide = "none")
# SES
SES <- GWM %>% 
  left_join(group_by(nGWM, strata, community, trait) %>% 
              summarise(nGWMmean = mean(nGWM, na.rm = T),
                        nGWMsd = sd(nGWM, na.rm = T))) %>% 
  mutate(SES = (GWM - nGWMmean)/nGWMsd) %>% 
  dplyr::select(-GWM, -nGWMmean, -nGWMsd) %>% 
  left_join(R)
# SES plot
# reshape2::melt(SES, id.vars = c("strata", "community", "trait", "SES")) %>% 
#   filter(variable != "BA") %>% 
#   ggplot(aes(value, SES, col = strata)) +
#   facet_grid(trait ~ variable, scales = "free") +
#   geom_point() +
#   geom_hline(yintercept = c(-2, 0, 2), linetype = "dashed") +
#   geom_smooth(method = "lm") +
#   theme(legend.position = "bottom", axis.title = element_blank())
```

```{r, eval=F}
filter(trees, community %in% filter(R, Canopy < 20, Slope > 30)$community) %>% 
  group_by(community, SpCode) %>% 
  summarise(Abundance = sum(Abundance)) %>% 
  left_join(filter(PFT, trait == "WD")) %>% 
  filter(strata == "U") %>% 
  arrange(community, desc(traitvalue)) %>% 
  kable(caption = "Community with low canopy (<20m) and strong slope (>30)")
filter(trees, community %in% filter(R, Slope < 15)$community) %>% 
  group_by(community, SpCode) %>% 
  summarise(Abundance = sum(Abundance)) %>% 
  left_join(filter(PFT, trait == "WD")) %>% 
  filter(strata == "U") %>% 
  arrange(community, desc(traitvalue)) %>% 
  kable(caption = "Community with low slope (<15)")
filter(PFT, strata == "U", trait == "WD") %>% 
  ggplot(aes(traitvalue)) +
  geom_histogram() +
  ggtitle("WD distribution among understory species.")
left_join(trees, PFT) %>% 
  filter(!is.na(strata)) %>% 
  group_by(strata, community) %>% 
  summarise(Abundance = sum(Abundance)) %>% 
  left_join(R) %>% 
  ggplot(aes(Slope, Abundance)) +
  geom_point() +
  facet_wrap(~ strata, scales = "free") +
  ggtitle("Number of trees per community along slope gradient.")
left_join(trees, filter(PFT, trait == "WD")) %>% 
  filter(strata == "U") %>% 
  filter(!is.na(traitvalue)) %>% 
  mutate(WDclass = cut(traitvalue, 
                       breaks = c(0, 0.5, 0.7, 1), 
                       labels = c("low", "mid", "high"))) %>% 
  group_by(WDclass, community) %>% 
  summarise(Abundance = sum(Abundance)) %>% 
  left_join(R) %>% 
  ggplot(aes(Slope, Abundance)) +
  geom_point() +
  facet_wrap(~ WDclass, scales = "free", nrow = 2) +
  ggtitle("Number of trees per community along slope gradient",
          "depending on WD category (low < 0.5 and high > 0.7).")
```


1. Sylvain Schmitt
    - Corresponding author
    - sylvain.m.schmitt@gmail.com
    - orcid.org/0000-0001-7759-7106
    - French Institute of Pondicherry, UMIFRE 21/USR 3330 CNRS-MAEE, Pondicherry, India
    - UMR BIOGECO, INRA - Université de Bordeaux, 69 route d’Arcachon, F-33612 Cestas cedex France
1. Valérie Raevel
    - vraevel@gmail.com
    - orcid.org/0000-0002-9631-114X
    - French Institute of Pondicherry, UMIFRE 21/USR 3330 CNRS-MAEE, Pondicherry, India
1. Maxime Réjou-Méchain
    - maxime.rejou@ird.fr
    - orcid.org/0000-0003-2824-267X
    - French Institute of Pondicherry, UMIFRE 21/USR 3330 CNRS-MAEE, Pondicherry, India
    - AMAP, IRD, CNRS, CIRAD, INRA, Univ Montpellier, Montpellier, France
1. Narayanan Ayyappan
    - ayyappan.n@ifpindia.org
    - French Institute of Pondicherry, UMIFRE 21/USR 3330 CNRS-MAEE, Pondicherry, India
1. Natesan Balachandran
    - balachandran.n@ifpindia.org
    - French Institute of Pondicherry, UMIFRE 21/USR 3330 CNRS-MAEE, Pondicherry, India
1. N. Barathan
    - barathan.n@ifpindia.org
    - French Institute of Pondicherry, UMIFRE 21/USR 3330 CNRS-MAEE, Pondicherry, India
1. Chandra Shekhar Jha
    - chandra.s.jha@gmail.com
    - National Remote Sensing Centre, Indian Space Research Organisation, Hyderabad 500 037, India 
1. François Munoz
    - fmunoz@univ-grenoble-alpes.fr
    - orcid.org/0000-0001-8776-4705
    - French Institute of Pondicherry, UMIFRE 21/USR 3330 CNRS-MAEE, Pondicherry, India
    - Laboratoire Interdisciplinaire de Physique, Univ. Grenoble Alpes, FR-38000 Grenoble, France
    
**Running title:** Functional assembly of canopy and understory tree

# Funding

No funding to declare. **Comment: ?**

\newpage 

# Abstract

* *Questions.* Topographic heterogeneity determines changing soil conditions, while canopy height modulates the microclimate in forest ecosystems. In addition, tree species form multiple vertical layers undergoing different light, biomechanic, and hydraulic constraints. However, how topography and canopy height influence the functional composition of vertical strata remain little addressed. We hypothesized that leaf and wood functional strategies differ between canopy and understory tree assemblages depending on local environmental heterogeneity.
* *Location.* An undisturbed, old-growth wet evergreen Dipterocarp forest plot located in the Kadamakal Reserve Forest, Karnataka State, India.
* *Methods.* We measured leaf and wood traits of 89 tree species representing 99% of all individuals in a 10-ha rainforest plot in the Western Ghats, South India. We subdivided the plot into subplots representing varying topographic conditions. We assigned tree species to guilds of canopy and understory trees. We combined tree census data, LiDAR-derived topographic and canopy metrics to assess the variation of the weighted means of functional trait values in understory and canopy guilds with canopy height and topography.
* *Results.* The variation of functional traits across sampled tree species followed decoupled wood and leaf economics spectra at the local scale. Although functional trait values did not differ overall between canopy and understory tree species, environmental filtering shaped different functional composition of canopy and understory guilds in tree communities. Furthermore, the functional composition of the canopy and understory guilds responded differently across communities to environmental gradients related to soil resource, light availability and aspect.
* *Conclusions.* These results show that both fine-scale environmental heterogeneity and vertical structure shape the composition of hyperdiverse rainforest tree communities. Guild-specific responses to biotic and abiotic environmental filtering underline that vertical stratification must be acknowledged to better understand and forecast forest dynamics.

## Keywords

Rainforest; Western Ghats; Economics spectra; Environmental filtering, Vertical strata

\newpage 

# Introduction 

Understanding the drivers of tree composition in hyperdiverse tropical forests is a long-standing issue in ecology [@Cody1976]. Environmental variation influences the composition of tree communities at regional [@Rejou-Mechain2008; @Tuomisto2003] and local [@Ferry2007; @gunatilleke_specieshabitat_2006] scales. Topography influences water and nutrient availability [@Blanchard2019; @ferry2010higher], in interaction with canopy height [@Jucker2018], and thereby filters different ecological strategies [@kraft_functional_2008; @Schmitt2020]. In addition,  tree species form different vertical strata at the adult stage allowing to distinguish guilds of understory and canopy trees. These vertical guilds should undergo contrasting environmental conditions: light availability decreases downward across vertical forest strata [@chazdon1984], while hydraulic and mechanical constraints increase upward [@Koch2004]. Therefore, we expect different survival and growth strategies to be filtered across strata [@Raevel2018; @Stark2015; @Uriarte2004a]. While much emphasis has been put on how ecological strategies of tree species vary with topography or canopy height in forests, far fewer works have addressed whether and how these variations depend on vertical guilds [@wright2002plant].

Functional traits have been defined as phenotypic traits that impact fitness through their effect on individual performance, which is defined as the ability to recruit, grow, survive, and reproduce in a given environment [@violle_let_2007]. Functional traits covary among species [@diaz_global_2015] and communities [@Bruelheide2018] along distinct economics spectra of leaf [@wright_worldwide_2004; @osnas_global_2013; but see @lloyd_photosynthetically_2013] and wood [@chave_towards_2009]. The leaf economics spectrum expresses a trade-off between resource acquisition by photosynthesis and investment in leaf defense and durability [@Evans2001a; @hodgson_is_2011; but see @Gibert2016]. Trait values along the leaf economics spectrum are expected to change along soil and light availability gradients, with more acquisitive strategies with decreasing resources availability [@hodgson_is_2011]. The wood economics spectrum opposes slow growing, drought-resistant species to fast growing, drought-intolerant species The wood economics spectrum opposes slow growing, drought-resistant species to fast growing, drought-intolerant species [@chave_towards_2009]. Whether and how trait variations along the leaf and wood economics spectra are decoupled across tropical tree species remain debated [@Baraloto2010; @fortunel_leaf_2012; but see @reich_world-wide_2014; @freschet_evidence_2010].  

Here, we measured leaf and wood traits of 89 species representing 99% of all individuals in a 10-ha forest plot. We categorized tree species as belonging to canopy and understory guilds at the adult stage. First, we analyzed the variation of functional traits across species and between guilds. Second, we combined trait information with tree census data, LiDAR-derived topographic and canopy metrics to characterize the functional composition of tree assemblages and their variation with topography [@Antin2013] and vertical structure [@Pascal1988]. We used multivariate approaches and linear regressions to address the following questions:

* Do functional trait variations among tree species follow independent leaf and wood economics spectra at local scale? If so, how are canopy and understory guilds distributed along leaf and wood economics spectra? 
* Does functional composition differ between assemblages of canopy and understory guilds? 
* Does the functional composition of guild assemblages vary with local environmental heterogeneity, and do the understory and canopy assemblages respond differently?

We hypothesized different trait-environment relationships across vertical guilds, with varying strategies along the leaf and wood economics spectra. First we expected understory species to be strongly light-limited but less subject to hydraulic and mechanical constraints than canopy species, so that understory species should have more conservative strategy [@herault_functional_2011] but less drought tolerance than canopy species . Second, because of the long dry season period and influence of intense monsoon during rainy seasons with strong wind disturbances, we expected topography and canopy height to influence particularly resource use strategies in our plot. Lower water and nutrient availability found on hilltops [@ferry2010higher] should entail more conservative strategy [@Cunningham2007; @kraft_functional_2008;@Schmitt2020], while acquisitive strategies are expected in bottom-lands. 

# Material and Methods

## Study site

The nearly 10-ha (300 m*330 m) permanent Uppangala plot was established in 1990 in an undisturbed, old-growth wet evergreen Dipterocarp forest [@Pascal1996] in the Kadamakal Reserve Forest (Karnataka State, India). Annual precipitation averages 5,100 mm per year but is highly variable across seasons with most rainfall (90%) occurring during the monsoon from June to October,  while a severe dry season (monthly rainfall of 45 mm) lasts 3.8 months on average [@pelissier_twenty_2011]. Mean annual temperatureis about 27°C, ranging from 25°C at rainfall peak to 29°C at dry season peak [data from a station at 15 km; @Pascal1996]. The geologic substrate is homogeneous within the plot [@Ferry1994], but the topography is highly heterogeneous with regular east-west alternation of thalwegs and ridges separated by steep slopes (Fig. \@ref(fig:Uppangala)). Topography is thus expected to be a major component of environmental variation within the forest plot [@Antin2013; @gimaret-carpentier_sampling_1998].

```{r Uppangala, fig.cap="Digital canopy model built from LiDAR data of the 10-ha forest permanent Uppangala plot , India. Thin and thick black lines represent the elevation contour lines and plot limits, respectively."}
DCM <- raster("./data/Canopy.tif")
crs(DCM) <- '+proj=utm +zone=43 +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0'
DEM <- raster("./data/DEM.tif")
crs(DEM) <- '+proj=utm +zone=43 +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0'
limits <- shapefile("./data/Plots/Shapeall10ha.shp")
limits$melt <- 1
limits <- maptools::unionSpatialPolygons(limits, limits$melt)
india <- shapefile("./data/India_SHP/INDIA.shp")
DCM <- crop(DCM, buffer(limits, 100))
DEM <- crop(DEM, buffer(limits, 100))
DEM <- as(DEM, "SpatialPixelsDataFrame")
DEM <- as.data.frame(DEM)
colnames(DEM) <- c("Elevation", "x", "y")
DCM <- as(DCM, "SpatialPixelsDataFrame")
DCM <- as.data.frame(DCM)
colnames(DCM) <- c("Height", "x", "y")
ggplot() +  
geom_tile(data = DCM, aes(x = x, y = y, fill = Height),  alpha = 0.6) +
  geom_contour(data = DEM, aes(x = x, y = y, z = Elevation),
               colour = "black", alpha = 0.5, breaks = seq(300, 500, by = 25)) +
  directlabels::geom_dl(data = DEM, aes(x = x, y = y, z = Elevation, label = paste0(..level.., "m")),
                        method = list('last.bumpup', cex = 0.8, hjust = 1, fontface = 2),
                        stat = "contour", breaks = seq(300, 500, by = 25)) +
  geom_polygon(data = fortify(limits),
               aes(long, lat, group=group),
               colour = "black", lwd = 1.1, alpha = 0) +
  coord_equal() +
  cowplot::theme_map() +
  scale_fill_distiller("Canopy\nheight (m)", palette = "Spectral") +
  ggsn::scalebar(dist = 50, dist_unit = "m", x.min = min(DCM$x) + 5, x.max = max(DCM$x), y.min = min(DCM$y) + 20, y.max = max(DCM$y),
                 transform = F, model = "WGS84", location = "bottomleft") +
    annotation_custom(grob = ggplotGrob(ggplot() +  
                                        geom_polygon(data = fortify(india),
                                                     aes(long, lat, group=group),
                                                     colour = "black", alpha = 0) +
                                        geom_point(data = data.frame(long = 75.662778, lat = 12.537500), 
                                                   aes(long, lat), col = "red", size = 3) +
                                        coord_equal() +
                                        cowplot::theme_map() +
                                        theme(panel.border = element_rect(color = "black",size = .5,fill = NA),
                                              plot.background	= element_rect(fill = "white"))), 
                    xmin = min(DCM$x), xmax = min(DCM$x) + 150, 
                    ymin = max(DCM$y) - 150, ymax = max(DCM$y))
  # ggsave(file = "Plot.png", path = './data/', width = 150, height = 200, unit = 'mm', dpi = 300)
```

## Census data and vertical guilds

All trees $\geq$ 10 cm in diameter at breast height (dbh) have been identified to species level, tagged, mapped and monitored since 1989 following international standards [@Jairazbhoy2006], in an area progressively extended to a contiguous 10-ha plot in 2014. The plot includes 6,672 tree individuals belonging to 111 species mostly belonging to the Dipterocarpaceae, Myristicaceae and Fabaceae families.

Using the classification of @Pascal1988, we assigned a potential vertical stratum to each tree species corresponding to the vertical stratum reached by the adult trees. The strata included four categories: emergent above 39 m, canopy between 25 and 39 m, sub-canopy between 15 and 25 m, and understory below 15 m. Because our study site is characterized by a steep topography (Fig. \@ref(fig:Uppangala)), sub-canopy species can often reach the canopy in the Uppangala plot. We thereby defined two broader categories, namely, canopy guild (C) including emergent, canopy and sub-canopy species and understory guild (U) composed of understory trees.

## Functional trait measurements

We collected trait data for 89 over the 111 (80%) species, representing 99% of tree individuals in the plot (54 canopy and 35 understory species). We sampled five individuals per species for the 32 most abundant species (>80% of individuals), and one to five individuals for the remaining species (3 individuals on average), depending on leaf accessibility and species abundance. For each individual, we collected at 4 to 12 m height five mature leaves and one branch sample with a diameter between 1 and 2 cm, following the recommendation of @Perez-Harguindeguy2013. Whenever possible, individuals and leaves were selected in similar light conditions (Dawkins index of 2; @Dawkins1958) **comment: beware double space**. Leaf and branch samples were kept in humidified ziplock bags filled with enriched $CO_2$ air in dark until measurement within the next 24 hours. For 11 species (1% of individuals in Uppangala plot), branch samples were too small (< to 1 cm in diameter) to allow measuring branch wood density.

We measured five functional traits (Table \@ref(tab:traits)) related to the major dimensions of ecological strategies in plants [@diaz_global_2015; @Wright2002] following the protocol of @Perez-Harguindeguy2013: 
leaf thickness (LT, $\mu m$), leaf area (LA, $mm^2$), leaf dry matter content (leaf dry weight divided by the leaf fresh weight, LDMC, $mg.g^{-1}$), specific leaf area (leaf area divided by the leaf dry mass, SLA, $m^2.kg^{-1}$), and branch wood density (wood dry weight divided by its volume, WD, $g.cm^{-3}$).
Leaf petioles, rachis and petiolules were removed for all measurements. Leaf fresh weight was measured with an digital balance at a 0.01 g precision (Wensar, KD-H600), leaf fresh thickness measured with a micrometer and leaf area by analyzing scanned images of fresh leaves with the ImageJ software [@Schneider2012]. Leaves were then kept in herbarium and oven-dried for at least 72 hours at 60°C before measurement of dry weight. We removed the bark and pit of branch samples in order to keep only branch wood without soft tissues. Branch wood samples were immersed in water to evaluate their volume by water displacement. We dried wood samples for 48 hours at 80°C before weighing.

```{r traits, results="latex"}
t <- genPFT() %>% 
  mutate(id = row.names(.)) %>% 
  select(-Tree, -Sp, -SpCode, -CE, -SHA, -LTD) %>% 
  melt(id.vars = "id", variable.name = 'Abbreviation') %>% 
  mutate(Abbreviation = as.character(Abbreviation)) %>% 
  left_join(data.frame(
    Trait = c('Leaf thickness', 'Leaf area', 'Leaf dry matter content', 'Specific leaf area', 'Wood density'),
    Abbreviation = c('LT', 'LA', 'LDMC', 'SLA', 'WD'),
    Unit = c('$\\mu m$', '$mm^2$', '$mg.g^-1$', '$m^2.kg^-1$', '$g.cm^-3$'),
    Strategy = c('Leaf defense and investment',
                 'Leaf resource capture vs. investment',
                 'Leaf defense and investment',
                 'Leaf resource acquisition vs. defense',
                 'Stem transport, structure and defense'),
    stringsAsFactors = F
  ),  by = "Abbreviation") %>% 
  group_by(Trait, Abbreviation, Unit, Strategy) %>% 
  summarise_if(is.numeric, funs(min(.,na.rm = T), max(., na.rm = T))) %>% 
  mutate(range = paste(round(min,2), "-", round(max,2))) %>% 
  select(-min, -max) %>% 
  left_join(genPFT() %>% 
              select(-Sp, -SpCode, -CE, -SHA, -LTD) %>% 
              melt(id.vars = 'Tree', 
                   variable.name = 'Abbreviation', 
                   value.name = 'Intra-individuals') %>% 
              mutate(Abbreviation = as.character(Abbreviation)) %>% 
              group_by(Tree, Abbreviation) %>% 
              summarise_all(funs(sd(., na.rm = T)/mean(., na.rm = T))) %>% 
              ungroup() %>% 
              select(-Tree) %>% 
              group_by(Abbreviation) %>% 
              summarise_all(funs(mean(., na.rm = T))),  by = "Abbreviation") %>% 
  left_join(genPFT() %>% 
              group_by(Tree, Sp, SpCode, CE) %>% 
              summarise_all(funs(mean)) %>% 
              ungroup() %>% 
              select(-Tree, -SpCode, -CE, -SHA, -LTD) %>% 
              melt(id.vars = 'Sp', 
                   variable.name = 'Abbreviation', value.name = 'Intra-species') %>% 
              mutate(Abbreviation = as.character(Abbreviation)) %>% 
              group_by(Sp, Abbreviation) %>% 
              summarise_all(funs(sd(., na.rm = T)/mean(., na.rm = T))) %>% 
              ungroup() %>% 
              select(-Sp) %>% 
              group_by(Abbreviation) %>% 
              summarise_all(funs(mean(., na.rm = T))),  by = "Abbreviation") %>% 
  left_join(genPFT() %>% 
              group_by(Tree, Sp, SpCode, CE) %>% 
              summarise_all(funs(mean)) %>% 
              ungroup() %>% 
              select(-Tree, -CE) %>% 
              group_by(Sp, SpCode) %>% 
              summarise_all(funs(mean)) %>% 
              ungroup() %>% 
              select(-Sp, -SpCode, -SHA, -LTD) %>%
              mutate(id = row.names(.)) %>% 
              melt(id.vars = "id", 
                   variable.name = 'Abbreviation', value.name = 'Inter-species') %>% 
              select(-id) %>% 
              mutate(Abbreviation = as.character(Abbreviation)) %>% 
              group_by(Abbreviation) %>%
              summarise_all(funs(sd(., na.rm = T)/mean(., na.rm = T))),
            by = "Abbreviation") %>%
  mutate(`Intra-individuals` = ifelse(Abbreviation == "WD", NA, `Intra-individuals`))
  
if(knitr:::is_latex_output()){
  t %>% 
    ungroup() %>% 
    mutate(Trait = c('Leaf area', 'Leaf dry\nmatter content', 'Leaf\nthickness', 'Specific\nleaf area', 'Wood\ndensity'),
    Strategy = c('Leaf defense\nand investment',
                 'Leaf resource\ncapture vs. investment',
                 'Leaf defense\nand investment',
                 'Leaf resource\nacquisition vs. defense',
                 'Stem transport,\nstructure and defense')) %>% 
    mutate_all(linebreak) %>% 
    kable(caption = "Functional traits measured, with their abbreviation, unit, related species strategy according to @baraloto_decoupled_2010, range of values, intra-individual, intra-specific and inter-specific coefficients of variation (CV).",
          digits = 2, format.args = list(big.mark = " "), format = 'pandoc', escape = F,
          col.names = c("Trait", "Abbreviation", "Unit", "Strategy", "Range", 
                        "\\makecell[l]{Intra-\\\\individuals}", 
                        "\\makecell[l]{Intra-\\\\species}", 
                        "\\makecell[l]{Inter-\\\\species}")) %>%
    kable_styling(full_width = T)
} else {  
  t %>% 
  kable(digits = 2, format.args = list(big.mark = " "), format = 'pandoc', escape = F,
                  col.names = c("Trait", "Abbreviation", "Unit", "Strategy", "Range", 
                        "Intra-individuals", "Intra-species", "Inter-species"),
        caption = "Functional traits measured, with their abbreviation, unit, related species strategy according to @baraloto_decoupled_2010, range of values, intra-individual, intra-specific and inter-specific coefficients of variation (CV).") %>% 
  kable_styling(full_width = T)
}
```

## Environmental variables

We used airborne LiDAR (Light Detection And Ranging) data to characterize the local topography and forest canopy structure. The LiDAR campaign was conducted in 2013, consistent with field measurements. Using a 1-m resolution LiDAR digital elevation model, we derived four statistically independent (Pearson’s r < 0.48) topographical variables: (i) curvature, related to local water and soil accumulation; (ii) wetness index, accounting for both slope and elevation and highlighting water flow paths and accumulation at the study area scale [@Bohner2006], (iii) southwesterness (SW), measured as $cos(aspect~in~degree+225)$, to account for the exposure to dominant monsoon winds from south-west [@Bunyan2015]; and (iv) slope, which could have both a strong effect on forest dynamics and on the availability of nutrients and water [@ferry2010higher]. In addition, based on a 1-m resolution LiDAR model of canopy (Fig. \@ref(fig:Uppangala)), we calculated the top canopy height, as a proxy of decreasing light availability downward and thus of local competition for light.

## Analyses

To assess the degree of trait variation and covariation, we first calculated the coefficient of variation (ratio of the standard deviation to the mean) of trait values among samples within individuals (intra-individual), among individuals within species (intra-specific) for species with more than one individual, and among species (inter-specific). We then performed a principal component analysis (PCA) of the average trait values per species to characterize the main dimensions of ecological strategies. We compared trait values between species according to the different vertical guilds.

We subsampled tree communities in $30~m*30~m$ subplots (n=110), and characterized the functional composition of vertical guilds within each subplot. Each subplot included 28 individuals and 10 species on average, with less species in understory (6 in average) than in canopy (13 in average) guilds. We calculated the weighted mean trait value per guild (GWM, where G stands for ‘guild’; [@Raevel2018]) **comment: beware double space** for each trait in each subplot:

$$GWM_j=\sum_{i=1}^Sp_{i,j}*t_i$$
where $p_{i,j}$ was the relative abundance of species $i$ in subplot $j$, $t_i$ the mean trait value of species $i$ and $S$ the number of species in the guild considered.

We explored the variation in functional composition according to local topography and canopy height for each guild. We designed a null model randomizing trait values among species within each guild (permuting rows in $Trait \times Species$ matrices of each guild; [@bernard-verdier_community_2012]) **comment: beware double space**. The null model thus broke the link between environment and local functional composition, while maintaining the spatial distribution of guilds and species abundances. We derived 999 randomized GWM values and calculated the standardized effect sizes (SES) quantifying the deviation of observed values from the null distribution, as

$$SES = \frac{GWM_{obs}-\overline{GWM_{null}}}{\sigma_{null}}$$
where $GWM_{obs}$ was the observed GWM, and $\overline{GWM_{null}}$ and $\sigma_{null}$ were the mean and standard deviation of the null distribution, respectively.

We analyzed the variation in functional composition, in terms of SES value, according to local topography and canopy height for each guild, by performing linear regressions. Predictors were normalised to ease model inference and enable their comparison. We performed analyses independently for each of the five functional traits, and performed Bayesian inference of parameter values using stan language [@Carpenter2017] and rstan package [@Team2018] in the R environment [@RCoreTeam2020].

# Results

## Trait variation and covariation

We found an overall increase of functional trait variation from intra-individual to inter-specific levels (Table \@ref(tab:traits)), even though LA showed almost same variability at intra-individual and intra-specific levels. Therefore, trait values averaged at species level could grasp most of the functional variability across tree individuals.

The first axis of the PCA of species trait values (Fig. \@ref(fig:pca)A) was mostly related to wood density and structural leaf traits (LT, LA, LDMC), and opposed species with thick, big leaves and lightwood to species with dense leaves and hardwood. The second axis mostly opposed SLA to LDMC. WD was orthogonal to SLA in the plan 1-2 of the PCA, suggesting that WD and SLA provided independent information. Canopy and understory species did not show significant differentiation along the first and second PCA axes (Wilcoxon p>0.2, Fig. \@ref(fig:pca)B).

```{r pca,  fig.cap='Principal Component Analysis (PCA) of species mean trait values (A) and density distribution of species per guild (C canopy, U understory) along the first two PCA axes (B). Subplot A shows PCA biplot in plan 1-2, whereas boxplots in B show guild differentiation on the first and second PCA axes, with the associated Wilcoxon test. See trait abbreviations in Table \\@ref(tab:traits).'}
pca.plot <- autoplot(PFT.pca, 
         data = na.omit(reshape2::dcast(PFT, strata + SpCode ~ trait, value.var = "traitvalue")),
         colour = "strata",
         loadings.label.size = 6,
         loadings.label.colour = 'black',
         loadings = T, loadings.label = T, loadings.colour = 'black',
         loadings.label.vjust = 1.2) +
  coord_equal() +
  geom_hline(aes(yintercept = 0), col = 'green', linetype = "dotted") +
  geom_vline(aes(xintercept = 0), col = 'purple', linetype = "dotted") +
  xlab('Axe 1 − 33.66 %') + ylab('Axe 2 − 29.07 %') +
  theme(legend.position = c(1, 1), 
        legend.justification = c(1, 1)) +
  scale_color_discrete("Guild")
spectrum.boxplots <- pca.plot$data %>%
  select(Comp.1, Comp.2, strata) %>%
  rename(`Axe 1` = Comp.1, `Axe 2` = Comp.2) %>%
  melt(id.vars = "strata", variable.name = "spectrum") %>%
  ggplot(aes(strata, value, fill = strata)) +
  # ggpubr::stat_compare_means(aes(label = ..p.signif..)) +
  geom_boxplot() +
  facet_wrap(~spectrum, nrow = 2) +
  scale_fill_discrete("Guild")
cowplot::plot_grid(pca.plot, spectrum.boxplots, rel_widths = c(2,1))
```

## Changes in functional composition with environment 

At community level, the guild weighted mean (GWM) of all traits significantly differed in subplots between understory and canopy guild assemblages (paired Student p<0.001,  Fig. \@ref(fig:GWMboxplot)). We found lower GWM values of canopy assemblages for SLA and WD with almost no overlap and, to a lesser extent, for LA but higher for LDMC and LT than understory tree assemblages. In other words, understory guild assemblages had larger, thinner and lighter leaves with higher SLA and denser woods, compared to canopy guild assemblages.

```{r GWMboxplot, fig.cap="Guild weighted mean (GWM) of leaf area (LA) , wood density (WD), leaf thickness (LT), leaf dry matter content (LDMC) and  specific leaf area (SLA) for canopy (C) and understory (U) guilds. Boxplots include the median value, the interquartile range (horizontal edges of the box) and an estimated 95% confidence interval (vertical lines). Asterisks represent significant differences between the two guilds (*** paired Student p-value<0.001).", fig.height=4}
ggplot(GWM, aes(x = strata, y = GWM, fill = strata)) +
  geom_boxplot() +
  facet_wrap(~trait, scales = "free", nrow = 1) +
  xlab("Guild") + scale_fill_discrete(guide = "none") +
  ggpubr::stat_compare_means(aes(label = paste(substr(..p.signif.., 1,3))))
```

Slope, curvature and wetness significantly influenced SES values of canopy and understory guild assemblages. Southwesterness influenced SES of canopy guild assemblages, while canopy height mostly played on SES of understory guild assemblages (Fig. \@ref(fig:LMres)). Overall, curvature was the most influential factor (7 significant effects out of 10 tested), with a negative effect on SLA and a positive effect on LT for both canopy and understory assemblages. In addition, curvature positively influenced SES of WD and LDMC only in the understory assemblages, and negatively influenced SES of LA only in the canopy assemblages. Wetness had a negative effect on SLA in both canopy and understory assemblages, and a positive effect on LT in understory assemblages. Still, wetness had a negative effect on LDMC in canopy assemblages. Slope had a negative effect on SLA and a positive effect on LT in canopy assemblages. and a positive effect on WD in the understory assemblages. Southwesterness only influenced canopy assemblages, with a positive effect on WD and a negative effect on LA. Canopy height mainly influenced understory assemblages, with a positive effect on SLA and a negative effect on WD, LDMC and LT. Still, canopy height had a positive effect on LA in canopy assemblages.

```{stan LMmodel, output.var="lm", cache=F, eval=F}
data {
  int<lower=1> N ;
  int<lower=1> K ;
  vector[N] SES ;
  matrix[N,K] X ;
}
parameters {
  real alpha ;
  vector [K] beta ;
  real<lower=0> sigma ;
}
model {
  SES ~ normal(alpha + X * beta, sigma) ;
}
generated quantities {
  real R2 = 1 - dot_self(SES - alpha - X * beta)/dot_self(SES - mean(SES)) ;
}
```

```{r LMres, fig.cap="Effects of slope, curvature, wetness, southwesterness, and canopy height on standardized effect size (SES) values of functional traits (display on the left)  for canopy and understory guilds. The effects of predictors (shown with different colors) was estimated as the posterior distribution of the slope parameters. Circles represent the mean estimate, thick lines the 50% credible interval, and thin lines the 90% credible interval. Non-significant posteriors are transparent and significant posteriors (p < 0.05) are opaque . See trait abbreviations in Table \\@ref(tab:traits)."}
mdata <- group_by(SES, strata, trait) %>% 
  mutate_at(c("Slope", "Curvature", "Wetness", "SW", "Canopy"), scale) %>% 
  group_by(strata, trait) %>% 
  do(mdata = list(N = nrow(.), K = 5, SES = .$SES, X = as.matrix(.[c("Slope", "Curvature", "Wetness", "SW", "Canopy")])))
fits <- lapply(mdata$mdata, function(m) sampling(lm, data = m))
names(fits) <- paste0(mdata$strata, "_", mdata$trait)
R2 <- lapply(fits, mcmc_intervals_data, regex_pars = "R2") %>% 
  bind_rows(.id = "model") %>% 
  separate(model, c("Guild", "Trait"), "_") %>% 
  mutate(R2 = m) %>% 
    mutate(Guild = recode(Guild, 
                           "U" = "Understory",
                           "C" = "Canopy")) %>% 
  dplyr::select(Guild, Trait, R2) %>% 
  mutate(Variable = "Canopy height", Significance = 1) %>% 
  mutate(R2 = paste0("R²=", round(R2, 2)))
lapply(fits, mcmc_intervals_data, regex_pars = "beta") %>% 
  bind_rows(.id = "model") %>% 
  separate(model, c("Guild", "Trait"), "_") %>% 
  mutate(Variable = recode(parameter, 
                           "beta[1]" = "Slope",
                           "beta[2]" = "Curvature",
                           "beta[3]" = "Wetness",
                           "beta[4]" = "Southwesterness",
                           "beta[5]" = "Canopy height")) %>% 
    mutate(Guild = recode(Guild, 
                           "U" = "Understory",
                           "C" = "Canopy")) %>% 
  mutate(Significance = 0) %>% 
  mutate(Significance = ifelse(m > 0 & ll > 0, 1, Significance)) %>% 
  mutate(Significance = ifelse(m < 0 & hh < 0, 1, Significance)) %>% 
  ggplot(aes(x = Variable, xend = Variable,
             color = Variable, fill = Variable,
             alpha = as.factor(Significance))) +
  geom_hline(yintercept = 0, color = "gray90", size = 1) +
  geom_hline(yintercept = c(-0.25, 0.25), 
             color = "gray90", size = 0.5, lty = "dashed") +
  geom_point(aes(y = m), shape = 21, size = 3) +
  geom_segment(aes(y = ll, yend = hh),
               size = 1, show.legend = F) +
  geom_segment(aes(y = l, yend = h), size = 2) +
  geom_text(y = -0.35, aes(label = R2), col = "black", data = R2) +
  coord_flip() +
  facet_grid(Trait ~ Guild, labeller = label_parsed, 
              scales = "free_y") +
  xaxis_title(F) +
  ylab("Standardised effect size") +
  scale_color_discrete(guide = "none") +
  scale_fill_discrete(guide = "none") +
  scale_alpha_manual(guide = "none", values = c(0.3, 1))
```

# Discussion

Few studies have compared the functional composition of canopy and understorey guilds in tropical forests and their variation along topography and with canopy height. Here we found contrasted results among species and among assemblages. On one hand, we found broad overlap in average functional trait values between species belonging to canopy and understory guilds. On the other hand, the functional composition of assemblages in subplots broadly differed between understory and canopy guilds. Furthermore, the guild assemblages responded differently to environmental variation across subplots. Functional composition of understory and canopy guild assemblages responded similarly to topographic wetness, but only the canopy guild responded to wind exposure, while functional composition of understory assemblages varied in response to canopy height. These results underline that multiple environmental factors play and determine different functional responses of vertical guilds in a tropical rainforest. **Comments on last sentence: A bit blur to me, Sylvain. Oui, on pourrait probablement se passer de cette phrase, François. Je partage cet avis. Valérie.**

## Decoupling of wood and leaf economics spectra at local scale

The PCA performed on species functional traits supported two orthogonal main dimensions (Fig. \@ref(fig:pca)). SLA and LDMC were opposed along a dimension representing the leaf economics spectrum [@diaz_global_2015; @wright_worldwide_2004], while wood density was opposed to leaf area and thickness along a dimension previously interpreted as the wood economics spectrum [@chave_towards_2009]. @Baraloto2010 and @Fortunel2012a also found orthogonal dimensions reflecting wood and leaf economic spectra of Neotropical tree species at a regional scale in Amazonia. Conversely, @Messier2017 advocated that these orthogonal spectra reflect large scale differences in tree functional strategies, and that the decoupling should not hold among species co-occurring at a local scale. Here, however, we captured the two orthogonal spectra across species at the scale of a 10 ha plot despite a limited number of traits compared to previous studies. Our results thus support that economics spectra are decoupled in tropical forests [@Baraloto2010] and do not form a single, whole-plant economics spectrum [@reich_world-wide_2014].

## Functional differences between canopy and understory guilds

We found that the species pools of canopy and understory species broadly overlapped in functional space, and both spanned a broad range of ecological strategies (Fig. \@ref(fig:pca)). Conversely, the functional composition of assemblages within 30 x 30m subplots differed between canopy and understory species (Fig. \@ref(fig:GWMboxplot)). Environmental conditions filtered species in assemblages according to their functional traits, leading to contrasted functional compositions between canopy and understory guilds. Understory assemblages had larger, thinner and lighter leaves, hence greater SLA, and denser wood than canopy guild assemblages. Greater hydraulic conduction is associated with lighter wood [@Santiago2018], which is especially important for canopy species. The conservative leaf strategy observed in assemblages of canopy species could originate from two mechanisms. First, leaf water stress is expected to increase with tree height due to gravity [@Koch2004] and to higher water evaporation associated with sun and wind exposure [@Chazdon1993]. Second, herbivory can be more intense in the canopy [@Sterck1992], selecting species resistant to herbivory with a more conservative strategy. Conversely, drought constraint could be less important for understory trees, allowing greater investment into resource acquisition by leaves, counterbalancing the higher need for light in shaded understory [@Chazdon1996]. However, limited light can also  entail slower growth [@Herault2011], favoring denser wood. These results support the hypothesis that guild-specific ecological constraints determine tree community assembly in a forest ecosystem [@duque2002different], leading to contrasting functional compositions of the assemblages of canopy and understory species.

## Different abiotic and biotic predictors of functional composition between canopy and understory assemblages **coments: I see what you mean but I d'ont like this title. I would instead introduce directly topography and canopy height instead of predictors. Sylvain. 
Your suggestion? Francois.**

We found that the assemblages of canopy and understory species responded differently to environmental predictors (Fig. \@ref(fig:LMres)).  Curvature, wetness and slope similarly affected the assemblages of canopy and understory species, except for LDMC. Locally convex wet, or flat areas tend to accumulate more soil, especially in hilly landscapes, and to retain more water, increasing soil fertility [@ferry2010higher]. These conditions are suitable for species with faster resource acquisition (higher SLA, and lower LDMC and LT) and growth (lower WD and higher LA). By contrast, concave, drier or sloppy areas should be drier and less fertile, then filtering species with more conservative strategies and slower growth.

In contrast to understory assemblages, functional composition of canopy trees depended on southwesterness, along the wood economics spectrum, with a greater WD and smaller LA for higher southwesterness. The influence of aspect on tropical forest composition has been little documented. @gunatilleke_specieshabitat_2006 found significant influence of aspect on forest composition in a similar climatic and topographical context in Sri Lanka and interpreted it as a consequence of a higher exposure to monsoon winds. The Uppangala plot is characterized by a large topographic heterogeneity, with steep slopes mostly organized along southwest-oriented crests (Fig. \@ref(fig:Uppangala)). South-west oriented slopes are likely to be more exposed to monsoon winds, which could entail greater tree damages and forest disturbance [@soman_aspects_1990]. The consequences could be that (i) tree strategies associated with mechanical resistance and disturbance tolerance could be selected in areas more exposed to monsoon wind damages [@Poorter2010b], and/or (ii) turbulences on northeast oriented areas could yield more disturbance and death events favoring pioneer, lightwood species [@larjavaara_rethinking_2010]. In both cases, canopy species are more exposed to wind disturbances than understory trees, and their functional composition is thus expected to be more responsive to wind exposure.

Conversely, we found pervasive influence of canopy height on the functional composition of understory assemblages for both leaf and wood economics, with increased acquisitive and growth strategies under taller canopies. Higher SLA and lower LDMC, LT and WD, suggested  greater investment into photosynthetic activity and growth in assemblages of understory trees under taller canopy. We expected canopy height to represent decreased light availability contrasting with the observed functional strategies expected under increased access to light [@kitajima_tissue-level_2010]. As canopy height is as dynamic as individual recruitment of current species assemblages, we hypothesized taller communities to result from more recent gaps with an increased abundance of acquisitive and fast growing post-pioneer species in understory. This hypothesis needs to be thoroughly tested with growth or canopy time series. **Comments from We expected canopy: Dans la mesure où les très grands arbres sont des émergents, on peut supposer que la canopée est moins "closed" horizontalement (on en avait déjà parlé). François. Je partage l'avis de François. Valérie. Formulation/signification peu claires. François. Pas sûr de comprendre ce que tu veux dire. François.**

## Conclusion

Our results show that functional variations among species and assemblages vary along the decoupled economic spectra of leaves and wood in an Indian rainforest. We found a significant effect of topography and canopy height on the functional composition of tree communities, but also pointed out that these effects change with vertical guilds. Our results suggest that forest community assembly is better understood as a combination of different, guild-specific assembly rules [@Raevel2018], representing different environmental constraints across vertical forest strata [@duque2002different]. Therefore, we call for designing trait-based studies at the level of ecological guilds coexisting at a given place [@Laroche2020]. We expect that decomposing guild dynamics should contribute to better understanding and predict global functioning of forests.

# Acknowledgements

We would like to thank Cedric Vega for extending Uppangala plot to 10 ha. We also want to acknowledge the data cleaning operated by Arianne Tanguy. And we are thankful to Claire Fortunel for her comments.

# Authors’ contributions

SS, MRM, FM and VR conceived the study, designed the methodology and analysed model outputs; SS, FM, VR, NA, NB and NB conducted the field sampling; NA, NB and NB identified species; MRM and CSJ provided the environmental data; SS, MRM, FM and VR led the writing of the manuscript. All the authors contributed to the drafts and gave their final approval for publication.

# Data availability

Functional traits data have been submitted to TRY initiative [@Kattge2019] under the name UppangalaTraits. 
Environmental variables and spatial positions of individuals were extracted from the Uppangala Station database.
Access to LiDAR data is restricted by the Indian government and should be the object of a convention (contact: chandra.s.jha@gmail.com). **Comment: Demander explicitement a Jha si ca lui convient quand tu enverras a tous les co-auteurs.**

# References
