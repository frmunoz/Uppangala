---
title: Topography and canopy height differently shape the functional composition of canopy and understory guilds in an Indian rainforest
date: '`r Sys.Date()`'
output:
  bookdown::word_document2:
    reference_docx: ./template/template.docx
  bookdown::pdf_document2:
    includes:
      before_body: ./template/doc_prefix.tex
      in_header: ./template/preamble.tex
    number_sections: false
    toc: false
  bookdown::html_document2:
    number_sections: false  
    toc: true
    toc_float: yes
linestretch: 1.5
csl: /home/sylvain/Documents/Bibliography/csl/joe.csl
bibliography: /home/sylvain/Documents/Bibliography/library.bib
link-citations: yes
---

```{r config, message=FALSE, warning=FALSE, include=FALSE}
rm(list = ls()); invisible(gc())
library(raster)
library(parallel)
library(knitr)
library(kableExtra)
if(knitr:::is_html_output()) options(knitr.table.format = "html") 
if(knitr:::is_latex_output()) options(knitr.table.format = "latex") 
library(tidyverse)
library(broom)
library(reshape2)
library(ggfortify)
library(rstan)
options(mc.cores = 4)
rstan_options(auto_write = T)
library(bayesplot)
theme_set(bayesplot::theme_default())
opts_chunk$set(echo = F, message = F, warning = F, 
               fig.height = 8, fig.width = 8,
               cache = T, cache.lazy = F)
cv <- function(x, na.rm = T)
  sd(x, na.rm = na.rm)/mean(x, na.rm = na.rm)
n = 999 # Random repetitions
sapply(list.files("R", full.names = T), source)
```

```{r data, include = F}
# Sp level PFT
PFT <- genPFT() %>% 
  mutate(LA = log(LA)) %>% 
  mutate(SLA = log(SLA)) %>% 
  select(-CE) %>% 
  group_by(Tree, Sp, SpCode) %>% 
  summarise_all(funs(mean(., na.rm = T))) %>% 
  ungroup() %>% 
  select(-Tree) %>% 
  group_by(Sp, SpCode) %>% 
  summarise_all(funs(mean(., na.rm = T))) %>% 
  ungroup() %>% 
  select(-LTD, -SHA, -Sp)
# PCA
PFT.pca <- princomp(~ LA + WD + LT + LDMC + SLA, data = PFT, cor = T)
# Matrix Q
PFT <- PFT %>% 
  mutate(SpCode = as.character(SpCode)) %>% 
  left_join(genSpecies(), by = "SpCode") %>% 
  mutate(strata = ifelse(Strata == 3, "U", "C")) %>%
  mutate(strata = ifelse(SpCode == "agin", "U", strata)) %>% 
  dplyr::select(strata, SpCode, LA, WD, LT, LDMC, SLA) %>% 
  reshape2::melt(id.vars = c("strata", "SpCode"), 
                 variable.name = "trait", value.name = "traitvalue")
# Matrix L
com <- quadrats(cs = c(30,30))
XY <- genTrees()[c('x', 'y')]
coordinates(XY) <- ~ x + y
proj4string(XY) <- crs(com)
trees <- genTrees() %>% 
  mutate(community = (XY %over% com)[,1]) %>% 
  filter(!is.na(community)) %>% 
  group_by(community, SpCode) %>% 
  summarise(Abundance = n())
# Matrix R
load(file.path("draft_save", 'R.Rdata'))
# GWM
GWM <- trees %>% 
  left_join(PFT) %>% 
  filter(!is.na(strata)) %>% 
  group_by(strata, community, trait) %>% 
  summarise(GWM = weighted.mean(traitvalue, Abundance, na.rm = T))
# GWM plot
left_join(GWM, R) %>% 
  reshape2::melt(id.vars = c("strata", "community", "trait", "GWM")) %>% 
  filter(variable != "BA") %>% 
  ggplot(aes(value, GWM, col = strata)) +
  facet_grid(trait ~ variable, scales = "free") +
  geom_point() +
  geom_smooth(method = "lm") +
  theme(legend.position = "bottom", axis.title = element_blank())
# nGWM
nGWM <- lapply(1:n, function(n) 
  left_join(trees, 
            group_by(PFT, trait, strata) %>% 
              mutate(SpCode = sample(SpCode)),
            by = "SpCode") %>% 
    filter(!is.na(strata)) %>% 
    group_by(strata, community, trait) %>% 
    summarise(nGWM = weighted.mean(traitvalue, Abundance, na.rm = T)) %>% 
    mutate(NullModel = n)) %>% 
  bind_rows()
# nGWM plot
# ggplot(nGWM, aes(nGWM, col = community), fill = NA) +
#   geom_density(alpha = .5) +
#   facet_wrap(~ strata + trait, scales = "free") +
#   scale_color_discrete(guide = "none")
# SES
SES <- GWM %>% 
  left_join(group_by(nGWM, strata, community, trait) %>% 
              summarise(nGWMmean = mean(nGWM, na.rm = T),
                        nGWMsd = sd(nGWM, na.rm = T))) %>% 
  mutate(SES = (GWM - nGWMmean)/nGWMsd) %>% 
  dplyr::select(-GWM, -nGWMmean, -nGWMsd) %>% 
  left_join(R)
# SES plot
# reshape2::melt(SES, id.vars = c("strata", "community", "trait", "SES")) %>% 
#   filter(variable != "BA") %>% 
#   ggplot(aes(value, SES, col = strata)) +
#   facet_grid(trait ~ variable, scales = "free") +
#   geom_point() +
#   geom_hline(yintercept = c(-2, 0, 2), linetype = "dashed") +
#   geom_smooth(method = "lm") +
#   theme(legend.position = "bottom", axis.title = element_blank())
```

```{r, eval=F}
filter(trees, community %in% filter(R, Canopy < 20, Slope > 30)$community) %>% 
  group_by(community, SpCode) %>% 
  summarise(Abundance = sum(Abundance)) %>% 
  left_join(filter(PFT, trait == "WD")) %>% 
  filter(strata == "U") %>% 
  arrange(community, desc(traitvalue)) %>% 
  kable(caption = "Community with low canopy (<20m) and strong slope (>30)")
filter(trees, community %in% filter(R, Slope < 15)$community) %>% 
  group_by(community, SpCode) %>% 
  summarise(Abundance = sum(Abundance)) %>% 
  left_join(filter(PFT, trait == "WD")) %>% 
  filter(strata == "U") %>% 
  arrange(community, desc(traitvalue)) %>% 
  kable(caption = "Community with low slope (<15)")
filter(PFT, strata == "U", trait == "WD") %>% 
  ggplot(aes(traitvalue)) +
  geom_histogram() +
  ggtitle("WD distribution among understory species.")
left_join(trees, PFT) %>% 
  filter(!is.na(strata)) %>% 
  group_by(strata, community) %>% 
  summarise(Abundance = sum(Abundance)) %>% 
  left_join(R) %>% 
  ggplot(aes(Slope, Abundance)) +
  geom_point() +
  facet_wrap(~ strata, scales = "free") +
  ggtitle("Number of trees per community along slope gradient.")
left_join(trees, filter(PFT, trait == "WD")) %>% 
  filter(strata == "U") %>% 
  filter(!is.na(traitvalue)) %>% 
  mutate(WDclass = cut(traitvalue, 
                       breaks = c(0, 0.5, 0.7, 1), 
                       labels = c("low", "mid", "high"))) %>% 
  group_by(WDclass, community) %>% 
  summarise(Abundance = sum(Abundance)) %>% 
  left_join(R) %>% 
  ggplot(aes(Slope, Abundance)) +
  geom_point() +
  facet_wrap(~ WDclass, scales = "free", nrow = 2) +
  ggtitle("Number of trees per community along slope gradient",
          "depending on WD category (low < 0.5 and high > 0.7).")
```


1. Sylvain Schmitt
    - Corresponding author
    - sylvain.m.schmitt@gmail.com
    - orcid.org/0000-0001-7759-7106
    - French Institute of Pondicherry, UMIFRE 21/USR 3330 CNRS-MAEE, Pondicherry, India
    - UMR BIOGECO, INRA - Université de Bordeaux, 69 route d’Arcachon, F-33612 Cestas cedex France
1. Valérie Raevel
    - vraevel@gmail.com
    - orcid.org/0000-0002-9631-114X
    - French Institute of Pondicherry, UMIFRE 21/USR 3330 CNRS-MAEE, Pondicherry, India
1. Maxime Réjou-Méchain
    - maxime.rejou@ird.fr
    - orcid.org/0000-0003-2824-267X
    - French Institute of Pondicherry, UMIFRE 21/USR 3330 CNRS-MAEE, Pondicherry, India
    - AMAP, IRD, CNRS, CIRAD, INRA, Univ Montpellier, Montpellier, France
1. Narayanan Ayyappan
    - ayyappan.n@ifpindia.org
    - French Institute of Pondicherry, UMIFRE 21/USR 3330 CNRS-MAEE, Pondicherry, India
1. Natesan Balachandran
    - balachandran.n@ifpindia.org
    - French Institute of Pondicherry, UMIFRE 21/USR 3330 CNRS-MAEE, Pondicherry, India
1. N. Barathan
    - barathan.n@ifpindia.org
    - French Institute of Pondicherry, UMIFRE 21/USR 3330 CNRS-MAEE, Pondicherry, India
1. Chandra Shekhar Jha
    - chandra.s.jha@gmail.com
    - National Remote Sensing Centre, Indian Space Research Organisation, Hyderabad 500 037, India 
1. François Munoz
    - fmunoz@univ-grenoble-alpes.fr
    - orcid.org/0000-0001-8776-4705
    - French Institute of Pondicherry, UMIFRE 21/USR 3330 CNRS-MAEE, Pondicherry, India
    - Laboratoire d'Écologie Alpine, Univ. Grenoble Alpes, FR-38000 Grenoble, France

\newpage 

# Changes

## 13 octobre 2020

* I changed the title.
* I removed the bidirectional stepwise selection of predictors as it was unstable.
* I used bayesian inference for the linear regression (minor).
* I replaced table 2 by a figure of posteriors distribution and significance (seemed clearer).
* I removed the ideas of LES and WES between strata. That's unclear and difficult to defend. WD model in understorey showed a $R^2=0.3$, which is huge and removed the idea that the WES mainly affects canopy. Similarly, SLA and LDMC models in canopy had low $R^2$ but showed significant effects of wetness, curvature and slope.
* I kept Maxime’s hypothesis for canopy height effect in understory. I don’t have a better hypothesis. I am therefore to keep it calling for further testing. **Maybe we should remove canopy height to simplify the message?**
* I am not a fan of the conclusion. I kept it for the moment but I didn’t feel it brought much more than the take home message; So I’m hesitating to simply remove it.

# Abstract

1. Topographic heterogeneity determines changing soil conditions, while the height of the canopy modulates the microclimate in the forest. But the environmental conditions encountered by trees also change across the vertical strata of tropical forests. However, the joint influence of topography and canopy height with vertical strata on tree functional composition remain little known. We hypothesized different leaf and wood functional strategies between canopy and understory guilds of trees, and different responses of the guilds to topographic heterogeneity and canopy height, depending on resource availability, hydraulic and biomechanical constraints.
1. We measured leaf and wood traits over 89 species representing 99% of all individuals in a 10-ha rainforest plot located in the Western Ghats, South India. The plot was subdivided into tree communities, each composed of guilds of canopy and understory trees. We combined tree census data, LiDAR-derived topographic and canopy metrics, and functional traits to assess the variation of functional composition in understory and canopy guilds, and to address the effects of abiotic and biotic environments on these compositions.
1. The variation of functional traits across sampled tree species followed locally decoupled wood and leaf economics spectra. Although functional space did not differ overall between canopy and understory tree species, environmental filtering shaped different functional composition of canopy and understory guilds in tree communities. Furthermore, the functional composition of the canopy and understory guilds responded differently across communities to environmental gradients related to soil resource, light availability and aspect.
1. *Synthesis.* These results show that both fine-scale environmental heterogeneity and vertical structure shape the composition of hyperdiverse rainforest tree communities. Guild-specific responses to biotic and abiotic environmental filtering underline that vertical stratification must be acknowledged to better understand and forecast forest dynamics.

## Keywords

Rainforest; Western Ghats; Economics spectra; Environmental filtering, Vertical strata

\newpage 

# Introduction 

Understanding the drivers of tree composition in hyperdiverse tropical forests is a long-standing issue in ecology [@Cody1976]. 
Environmental variation influences the composition of tree community at regional [@Rejou-Mechain2008; @Tuomisto2003] 
and local scale [@Ferry2007; @gunatilleke_specieshabitat_2006]. 
Topography is known to filter different ecological strategies [@kraft_functional_2008; @Schmitt2020]
due to its impact on water and nutrient availability [@Blanchard2019; @ferry2010higher].
In addition, canopy height modulates forest microclimates due to topography [@Jucker2018].
But, tree species  occupy different vertical strata at adult stage, and can thus be classified into different vertical guilds (understory and canopy),
experimenting contrasted environmental conditions. 
Indeed, light availability decreases downward across vertical forest strata [@chazdon1984],
while hydraulic and mechanical constraints increase upward [@Koch2004], 
so that different survival and growth strategies are filtered across strata [@Raevel2018; @Stark2015; @Uriarte2004a]. 
While functional strategies of tree species have been documented independently across topography, canopy height and vertical guilds,
little is known on their interactions,
particularly the effect of topography and canopy height on species assemblages between vertical guilds has not been addressed [@wright2002plant].

Functional traits express fundamental trade-offs determining species occurrences and co-occurrences along environmental gradients [@Wright2002], 
contributing thus to test for community assembly processes. 
Functional traits have been defined as phenotypic traits that impact fitness through their effect on individual performance, which is defined as the ability to recruit, grow, survive, and reproduce in a given environment [@violle_let_2007].
Functional traits covary among species [@diaz_global_2015] and communities [@Bruelheide2018
along distinct economics spectra of leaf [@wright_worldwide_2004; @osnas_global_2013; but see @lloyd_photosynthetically_2013] and wood [@chave_towards_2009].
The leaf economics spectrum expresses a trade-off between resource acquisition by photosynthesis and investment in leaf defense and durability [@Evans2001a; @hodgson_is_2011; but see @Gibert2016].
Trait values along the leaf economics spectrum are expected to change along soil and light availability gradients. 
The wood economics spectrum opposes slow growing, drought-resistant species to fast growing, drought-intolerant species [@chave_towards_2009].
Previous studies showed decoupled trait variations along the leaf and wood economics spectra for tropical trees at large scale in the Neotropics [@Baraloto2010; @fortunel_leaf_2012]. 
Nevertheless, @reich_world-wide_2014
proposed a unique plant economics spectrum simply opposing fast and slow growing species as observed in subarctic flora [@freschet_evidence_2010].
The concept of plant economics spectrum may be highly relevant for understanding the variation of strategy between vertical guilds as understory species are generally characterized by a low potential growth rate associated to a conservative strategy of resource use, while canopy species tend to have a higher potential growth rate associated to a faster resource acquisition [@Herault2011].

In the context of seasonal rainforests, we hypothesized different trait-environment relationships across vertical guilds, 
with varying strategies along the fundamental leaf and wood economics spectra. 
More specifically, because understory trees are strongly light-limited and are less subject to hydraulic and mechanical constraints than canopy trees, 
we expect that  understory and canopy species tend to maximize their difference along the leaf and wood economic spectra, respectively. 
More generally, we expect that understory species and assemblages have more conservative strategies than canopy ones and that the lower water and nutrient availability found on hilltops [@ferry2010higher] 
entail stronger conservative resource-use strategy [@Cunningham2007; @kraft_functional_2008; @Mendez-Toribio2017; @Schmitt2020]. 
Previous works have shown different response of vertical strata to environmental variation at ground level, with increased edaphic constraint on understory compared to canopy  for Columbian drained uplands [@duque2002different].

Here, we assessed the variation in functional composition of understory and canopy guilds within tropical tree communities, 
and examined the effects of topography and canopy height on these variations. 
We measured leaf and wood traits of 89 species representing 99% of all individuals in a 10-ha forest plot located in the Western Ghats, South India, a region considered as a global biodiversity hotspot [@myers_biodiversity_2000].
The plot encompasses a broad variation of topography [@Antin2013] and vertical structure [@Pascal1988].
Because the region experiences a long dry season period and is under the influence of intense monsoon during rainy seasons with strong wind disturbances, 
we expected hydraulic and mechanical constraints to play an important role in tree community assembly.

We used tree census data, LiDAR-derived topographic and canopy metrics and measured functional traits, 
in multivariate approaches and linear regressions to address the following questions: 
(i) Do functional trait variations among tree species follow independent leaf and wood economics spectra at local scale? 
If so, how are canopy and understory guilds distributed along leaf and wood economics spectra? 
(ii) Does functional composition differ between assemblages of canopy and understory guilds? 
and (iii) Does the functional composition of guild assemblages vary with local environmental heterogeneity, and do the understory and canopy assemblages respond differently?

# Material and Methods

## Study site

The study was carried out in a nearly 10-ha (300 m*330 m) permanent plot established in 1990 in an undisturbed, old-growth wet evergreen Dipterocarp forest [@Pascal1996]. The plot is named after the nearest village, Uppangala, and is located in the Kadamakal Reserve Forest (Kodagu District, Karnataka State, India). Annual precipitation averages 5,100 mm per year but is highly variable across seasons with heavy rainfall during the monsoon from June to October (90% of the rainfall) and a severe dry season (monthly rainfall of 45 mm) lasting 3.8 months on average [@pelissier_twenty_2011]. Mean annual temperature in the station of Sampaji (15 km from Uppangala) is about 27°C, ranging from 25°C at rainfall peak to 29°C at dry season peak [@Pascal1996]. The geologic substrate can be considered homogeneous within the Uppangala plot [@Ferry1994], but the topography is highly heterogeneous with regular east-west alternation of thalwegs and ridges separated by steep slopes (Fig. \@ref(fig:Uppangala)). Topography is thus expected to be a major component of environmental variation within the forest plot [@Antin2013; @gimaret-carpentier_sampling_1998].

```{r Uppangala, fig.cap="Digital canopy model of the 10-ha forest permanent plot in Uppangala, India. Thin and thick black lines represent the elevation contour lines and plot limits, respectively."}
DCM <- raster("./data/Canopy.tif")
crs(DCM) <- '+proj=utm +zone=43 +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0'
DEM <- raster("./data/DEM.tif")
crs(DEM) <- '+proj=utm +zone=43 +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0'
limits <- shapefile("./data/Plots/Shapeall10ha.shp")
limits$melt <- 1
limits <- maptools::unionSpatialPolygons(limits, limits$melt)
india <- shapefile("./data/India_SHP/INDIA.shp")
DCM <- crop(DCM, buffer(limits, 100))
DEM <- crop(DEM, buffer(limits, 100))
DEM <- as(DEM, "SpatialPixelsDataFrame")
DEM <- as.data.frame(DEM)
colnames(DEM) <- c("Elevation", "x", "y")
DCM <- as(DCM, "SpatialPixelsDataFrame")
DCM <- as.data.frame(DCM)
colnames(DCM) <- c("Height", "x", "y")
ggplot() +  
geom_tile(data = DCM, aes(x = x, y = y, fill = Height),  alpha = 0.6) +
  geom_contour(data = DEM, aes(x = x, y = y, z = Elevation),
               colour = "black", alpha = 0.5, breaks = seq(300, 500, by = 25)) +
  directlabels::geom_dl(data = DEM, aes(x = x, y = y, z = Elevation, label = paste0(..level.., "m")),
                        method = list('last.bumpup', cex = 0.8, hjust = 1, fontface = 2),
                        stat = "contour", breaks = seq(300, 500, by = 25)) +
  geom_polygon(data = fortify(limits),
               aes(long, lat, group=group),
               colour = "black", lwd = 1.1, alpha = 0) +
  coord_equal() +
  cowplot::theme_map() +
  scale_fill_distiller("Canopy\nheight (m)", palette = "Spectral") +
  ggsn::scalebar(dist = 50, dist_unit = "m", x.min = min(DCM$x) + 5, x.max = max(DCM$x), y.min = min(DCM$y) + 20, y.max = max(DCM$y),
                 transform = F, model = "WGS84", location = "bottomleft") +
    annotation_custom(grob = ggplotGrob(ggplot() +  
                                        geom_polygon(data = fortify(india),
                                                     aes(long, lat, group=group),
                                                     colour = "black", alpha = 0) +
                                        geom_point(data = data.frame(long = 75.662778, lat = 12.537500), 
                                                   aes(long, lat), col = "red", size = 3) +
                                        coord_equal() +
                                        cowplot::theme_map() +
                                        theme(panel.border = element_rect(color = "black",size = .5,fill = NA),
                                              plot.background	= element_rect(fill = "white"))), 
                    xmin = min(DCM$x), xmax = min(DCM$x) + 150, 
                    ymin = max(DCM$y) - 150, ymax = max(DCM$y))
  # ggsave(file = "Plot.png", path = './data/', width = 150, height = 200, unit = 'mm', dpi = 300)
```

## Taxonomic composition and trait sampling

All trees $\geq$ 10 cm in diameter at breast height (dbh) have been identified to species level, tagged, mapped and monitored since 1989 following international standards [@Jairazbhoy2006], in an area progressively extended to a contiguous 10-ha plot in 2014.
The plot includes 6,672 tree individuals belonging to 111 species mostly belonging to the Dipterocarpaceae, Myristicaceae and Fabaceae families. 

Using the classification of @Pascal1988, we assigned a potential vertical stratum to each tree species corresponding to the vertical stratum reached by most adult trees.
The strata included four categories: emergent above 39 m, canopy between 25 and 39 m, sub-canopy between 15 and 25 m, and understory below 15 m. 
Because our study site is characterized by a steep topography (Fig. \@ref(fig:Uppangala)), 
sub-canopy species can often reach the canopy in the Uppangala plot. 
We thereby defined two broader categories, namely, canopy guild (C) including emergent, 
canopy and sub-canopy species and understory guild (U) composed of understory trees.

We collected trait data for 89 over the 111 (80%) species, representing 99% of tree individuals in the plot (54 canopy and 35 understory species). We sampled five individuals per species for the 32 most abundant species (>80% of individuals), and one to five individuals for the remaining species (3 individuals on average), depending on leaf accessibility and species abundance. For each individual, we collected at 4 to 12 m height five mature leaves and one branch sample with a diameter between 1 and 2 cm, following the recommendation of @Perez-Harguindeguy2013. Whenever possible, individuals and leaves were selected in similar light conditions (Dawkins index of 2; [@Dawkins1958]). Leaf and branch samples were kept in humidified ziplock bags filled with enriched $CO_2$ air in dark until measurement within the next 24 hours. For 11 species (1% of individuals in Uppangala plot), branch samples were too small (< to 1 cm in diameter) to allow measuring branch wood density. 

## Trait measurements

We measured five functional traits (Table \@ref(tab:traits)) related to the major dimensions of ecological strategies in plants [@diaz_global_2015; @Wright2002]: leaf thickness (LT, $\mu m$), leaf area (LA, $mm^2$), leaf dry matter content (leaf dry weight divided by the leaf fresh weight, LDMC, $mg.g^{-1}$), specific leaf area (leaf area divided by the leaf dry mass, SLA, $m^2.kg^{-1}$), and branch wood density (wood dry weight divided by its volume, WD, $g.cm^{-3}$). Leaf petioles, rachis and petiolules were removed for all measurements. Leaf fresh weight was measured with an analytical balance at a 0.01 g precision (Wensar, KD-H600), leaf fresh thickness with a micrometer and leaf area by  analyzing scanned images of fresh leaves with the ImageJ software [@Schneider2012]. Leaves were then kept in herbarium and oven-dried for at least 72 hours at 60°C before measurement of dry weight. The bark and pit of branch samples were removed in order to keep only branch wood without soft tissues. Branch wood samples were immersed in water to evaluate their volume by water displacement. Wood samples were then dried for 48 hours at 80°C and weighed following the protocol of @Perez-Harguindeguy2013.

```{r traits, results="latex"}
t <- genPFT() %>% 
  mutate(id = row.names(.)) %>% 
  select(-Tree, -Sp, -SpCode, -CE, -SHA, -LTD) %>% 
  melt(id.vars = "id", variable.name = 'Abbreviation') %>% 
  mutate(Abbreviation = as.character(Abbreviation)) %>% 
  left_join(data.frame(
    Trait = c('Leaf thickness', 'Leaf area', 'Leaf dry matter content', 'Specific leaf area', 'Wood density'),
    Abbreviation = c('LT', 'LA', 'LDMC', 'SLA', 'WD'),
    Unit = c('$\\mu m$', '$mm^2$', '$mg.g^-1$', '$m^2.kg^-1$', '$g.cm^-3$'),
    Strategy = c('Leaf defense and investment',
                 'Leaf resource capture vs. investment',
                 'Leaf defense and investment',
                 'Leaf resource acquisition vs. defense',
                 'Stem transport, structure and defense'),
    stringsAsFactors = F
  ),  by = "Abbreviation") %>% 
  group_by(Trait, Abbreviation, Unit, Strategy) %>% 
  summarise_if(is.numeric, funs(min(.,na.rm = T), max(., na.rm = T))) %>% 
  mutate(range = paste(round(min,2), "-", round(max,2))) %>% 
  select(-min, -max) %>% 
  left_join(genPFT() %>% 
              select(-Sp, -SpCode, -CE, -SHA, -LTD) %>% 
              melt(id.vars = 'Tree', 
                   variable.name = 'Abbreviation', 
                   value.name = 'Intra-individuals') %>% 
              mutate(Abbreviation = as.character(Abbreviation)) %>% 
              group_by(Tree, Abbreviation) %>% 
              summarise_all(funs(sd(., na.rm = T)/mean(., na.rm = T))) %>% 
              ungroup() %>% 
              select(-Tree) %>% 
              group_by(Abbreviation) %>% 
              summarise_all(funs(mean(., na.rm = T))),  by = "Abbreviation") %>% 
  left_join(genPFT() %>% 
              group_by(Tree, Sp, SpCode, CE) %>% 
              summarise_all(funs(mean)) %>% 
              ungroup() %>% 
              select(-Tree, -SpCode, -CE, -SHA, -LTD) %>% 
              melt(id.vars = 'Sp', 
                   variable.name = 'Abbreviation', value.name = 'Intra-species') %>% 
              mutate(Abbreviation = as.character(Abbreviation)) %>% 
              group_by(Sp, Abbreviation) %>% 
              summarise_all(funs(sd(., na.rm = T)/mean(., na.rm = T))) %>% 
              ungroup() %>% 
              select(-Sp) %>% 
              group_by(Abbreviation) %>% 
              summarise_all(funs(mean(., na.rm = T))),  by = "Abbreviation") %>% 
  left_join(genPFT() %>% 
              group_by(Tree, Sp, SpCode, CE) %>% 
              summarise_all(funs(mean)) %>% 
              ungroup() %>% 
              select(-Tree, -CE) %>% 
              group_by(Sp, SpCode) %>% 
              summarise_all(funs(mean)) %>% 
              ungroup() %>% 
              select(-Sp, -SpCode, -SHA, -LTD) %>%
              mutate(id = row.names(.)) %>% 
              melt(id.vars = "id", 
                   variable.name = 'Abbreviation', value.name = 'Inter-species') %>% 
              select(-id) %>% 
              mutate(Abbreviation = as.character(Abbreviation)) %>% 
              group_by(Abbreviation) %>%
              summarise_all(funs(sd(., na.rm = T)/mean(., na.rm = T))),
            by = "Abbreviation") %>%
  mutate(`Intra-individuals` = ifelse(Abbreviation == "WD", NA, `Intra-individuals`))
  
if(knitr:::is_latex_output()){
  t %>% 
    ungroup() %>% 
    mutate(Trait = c('Leaf area', 'Leaf dry\nmatter content', 'Leaf\nthickness', 'Specific\nleaf area', 'Wood\ndensity'),
    Strategy = c('Leaf defense\nand investment',
                 'Leaf resource\ncapture vs. investment',
                 'Leaf defense\nand investment',
                 'Leaf resource\nacquisition vs. defense',
                 'Stem transport,\nstructure and defense')) %>% 
    mutate_all(linebreak) %>% 
    kable(caption = 'Functional traits measured. Traits are presented with their abbreviation, unit, related species strategy according to @baraloto_decoupled_2010, range of values, intra-individual, intra-specific and inter-specific coefficients of variation (CV).',
          digits = 2, format.args = list(big.mark = " "), format = 'pandoc', escape = F,
          col.names = c("Trait", "Abbreviation", "Unit", "Strategy", "Range", 
                        "\\makecell[l]{Intra-\\\\individuals}", 
                        "\\makecell[l]{Intra-\\\\species}", 
                        "\\makecell[l]{Inter-\\\\species}")) %>%
    kable_styling(full_width = T)
} else {  
  t %>% 
  kable(digits = 2, format.args = list(big.mark = " "), format = 'pandoc', escape = F,
                  col.names = c("Trait", "Abbreviation", "Unit", "Strategy", "Range", 
                        "Intra-individuals", "Intra-species", "Inter-species"),
        caption = 'Functional traits measured. Traits are presented with their abbreviation, unit, related species strategy according to @baraloto_decoupled_2010, range of values, intra-individual, intra-specific and inter-specific coefficients of variation (CV).') %>% 
  kable_styling(full_width = T)
}
```

## Environmental variables

We used airborne LiDAR (Light Detection And Ranging) data to characterize the local topography and forest canopy structure. The LiDAR campaign was conducted in 2013, consistent with field measurements. Using a 1-m resolution LiDAR digital elevation model, we derived four statistically independent (Pearson’s r < 0.48) topographical variables: (i) curvature, related to local water and soil accumulation areas; (ii) wetness, an index accounting for both slope and elevation and highlighting water flow paths and accumulation at the study area scale [@Bohner2006], (iii) southwesterness (SW), representing the topographical aspect in the direction of south-west: $cos(aspect~in~degree+225))$ to account for the exposure to dominant monsoon winds [@Bunyan2015]; and (iv) slope, which could have both a strong effect on forest dynamics and on the availability of nutrients and water [@ferry2010higher]. In addition, based on a 1-m resolution LiDAR model of canopy (Fig. \@ref(fig:Uppangala)), we calculated the top canopy height, as a proxy of decreasing light availability downward and thus of local competition for light.

## Analyses

To assess the degree of trait variation and covariation, we first calculated the coefficient of variation (ratio of the standard deviation to the mean) of trait values among samples within individuals (intra-individual), among individuals within species (intra-specific) for species with more than one individual, and among species (inter-specific). We then performed a principal component analysis (PCA) of average trait values per species to characterize the main dimensions of ecological strategies globally as well as per vertical stratum.

We subsampled tree communities in $30~m*30~m$ subplots (n=110), in order to characterize the functional composition of vertical guilds within each subplot. Each subplot contained 28 individuals and 10 species on average, with less species in understory (6 in average) than in canopy (13 in average) guilds. We thus calculated the weighted mean trait value per guild (GWM, where G stands for ‘guild’; [@Raevel2018]) for each trait in each subplot:

$$GWM_j=\sum_{i=1}^Sp_{i,j}*t_i$$
where $p_{i,j}$ was the relative abundance of species $i$ in subplot $j$, $t_i$ the mean trait value of species $i$ and $S$ the number of species in the guild considered.

We tested whether variation in functional composition depended on local topography and canopy height for each guild, based on a null model randomizing trait values among species within each guild (permuting rows in $Trait \times Species$ matrices of each guild; [@bernard-verdier_community_2012]). The null model broke the link between environment and local functional composition while maintaining the spatial distribution of guilds and species abundances. We derived 999 randomized GWM values and calculated the standardized effect sizes (SES) quantifying the deviation of observed values from the null distribution as

$$SES = \frac{GWM_{obs}-\overline{GWM_{null}}}{\sigma_{null}}$$
where $GWM_{obs}$ was the observed GWM, and $\overline{GWM_{null}}$ and $\sigma_{null}$ were the mean and standard deviation of the null distribution, respectively.

We assessed how the deviation of guild composition from the null model depended on environmental variables by performing linear regressions.
Predictors were all normalised to ease model inference and enable their comparison. 
The analyses were performed independently for each of the five functional traits.
A Bayesian method was used to infer parameters using stan language [@Carpenter2017] and rstan package [@Team2018] in the R environment [@RCoreTeam2020].


# Results

## Trait variation and covariation

We found an overall increase of functional trait variation from intra-individual to inter-specific levels (Table \@ref(tab:traits)), even though LA showed almost as much variability at intra-individual and at intra-specific levels. Thus, trait values averaged at species level could grasp most of the functional variability across guilds and communities with varying taxonomic composition.

The first axis of the PCA performed on species trait values (Fig. \@ref(fig:pca)A) was mostly related to wood density and structural leaf traits (LT, LA, LDMC), and opposed species with thick, big leaves and lightwood to species with dense leaves and hardwood. The second axis mostly opposed SLA to LDMC. WD was orthogonal to SLA in the plan 1-2 of the PCA suggesting that WD and SLA provide independent information. Canopy and understory species did not show significant differentiation along the first and second PCA axis (Wilcoxon p>0.2, Fig. \@ref(fig:pca)B).

```{r pca,  fig.cap='Principal Component Analysis (PCA) of species mean trait values (A) and density distribution of species per guild (C canopy, U understory) along the first two PCA axes (B). Subplot A shows PCA biplot in plan 1-2, whereas boxplots in B show guild differentiation on the first and second PCA axes, with the associated Wilcoxon test. See Table  \\@ref(tab:traits) for trait abbreviations.'}
pca.plot <- autoplot(PFT.pca, 
         data = na.omit(reshape2::dcast(PFT, strata + SpCode ~ trait, value.var = "traitvalue")),
         colour = "strata",
         loadings.label.size = 6,
         loadings.label.colour = 'black',
         loadings = T, loadings.label = T, loadings.colour = 'black',
         loadings.label.vjust = 1.2) +
  coord_equal() +
  geom_hline(aes(yintercept = 0), col = 'green', linetype = "dotted") +
  geom_vline(aes(xintercept = 0), col = 'purple', linetype = "dotted") +
  xlab('Axe 1 − 33.66 %') + ylab('Axe 2 − 29.07 %') +
  theme(legend.position = c(1, 1), 
        legend.justification = c(1, 1)) +
  scale_color_discrete("Guild")
spectrum.boxplots <- pca.plot$data %>%
  select(Comp.1, Comp.2, strata) %>%
  rename(`Axe 1` = Comp.1, `Axe 2` = Comp.2) %>%
  melt(id.vars = "strata", variable.name = "spectrum") %>%
  ggplot(aes(strata, value, fill = strata)) +
  # ggpubr::stat_compare_means(aes(label = ..p.signif..)) +
  geom_boxplot() +
  facet_wrap(~spectrum, nrow = 2) +
  scale_fill_discrete("Guild")
cowplot::plot_grid(pca.plot, spectrum.boxplots, rel_widths = c(2,1))
```

## Changes in functional composition with environment 

At community level, the guild weighted mean (GWM) of all traits significantly differed between understory and canopy guilds (Student p<0.001, Fig. \@ref(fig:GWMboxplot)). GWM values of canopy assemblages were lower for SLA and WD with almost no overlap and, to a lesser extent, lower for LA and higher for LDMC and LT than understory tree assemblages. In other words, understory guild assemblages had larger, thinner and lighter leaves with higher SLA and denser woods, compared to canopy guild assemblages.

```{r GWMboxplot, fig.cap="Guild weighted mean (GWM) of specific leaf area (SLA), wood density (WD), leaf dry matter content (LDMC), leaf area (LA) and leaf thickness (LT) for canopy (C) and understory (U) guilds. Boxplots include the median value, the interquartile range (horizontal edges of the box) and an estimated 95% confidence interval (vertical lines). Asterisks represent significant differences between the two guilds (*** p-value<0.001).", fig.height=4}
ggplot(GWM, aes(x = strata, y = GWM, fill = strata)) +
  geom_boxplot() +
  facet_wrap(~trait, scales = "free", nrow = 1) +
  xlab("Guild") + scale_fill_discrete(guide = "none") +
  ggpubr::stat_compare_means(aes(label = paste(substr(..p.signif.., 1,3))))
```

We detected a significant effect of slope, curvature and wetness on both canopy and understory guild assemblages, 
of southwesterness on canopy guild assemblages 
and of canopy height mostly on understory guild assemblages (Fig. \@ref(fig:LMres)).
Curvature appeared as the most influential factor (7 significant effects out of 10 tested), 
with a negative effect on SLA and a positive effect on LT in both canopy and understory assemblages. 
In addition, curvature had a positive effect on WD and LDMC only in the understory assemblages,
and a negative effect on LA only in the canopy assemblages. 
Similarly to curvature, wetness had a negative effect on SLA in both canopy and understory assemblages,
and a positive effect on LT in the understory assemblages.
Still, wetness had a negative effect on LDMC in canopy assemblages.
As curvature, slope had a negative effect on SLA and a positive effect on LT in canopy assemblages. 
and a positive effect on WD in the understory assemblages.
Southwesterness only influenced canopy assemblages,
with a positive effect on WD and a negative effect on LA. 
Canopy height mainly influenced understory assemblages,
with a positive effect on SLA and a negative effect on WD, LDMC and LT.
Still, canopy height  had a positive effect on LA in canopy assemblages.

```{stan LMmodel, output.var="lm"}
data {
  int<lower=1> N ;
  int<lower=1> K ;
  vector[N] SES ;
  matrix[N,K] X ;
}
parameters {
  real alpha ;
  vector [K] beta ;
  real<lower=0> sigma ;
}
model {
  SES ~ normal(alpha + X * beta, sigma) ;
}
generated quantities {
  real R2 = 1 - dot_self(SES - alpha - X * beta)/dot_self(SES - mean(SES)) ;
}
```

```{r LMres, fig.cap="Effects of slope, curvature, wetness, southwesterness, and canopy height on  standardized effect size values of functional traits for canopy and understory guilds. The effects of predictors was estimated as the posterior distribution of the slope parameters using Bayesian inference. Circles represent the mean estimate, thick lines the 50% confidence interval, and thin lines the 90% confidence interval, and colour the corresponding predictor of the posterior distributions. Transparency represents significance, with transparent non-significant posteriors and opaque significant posteriors (p < 0.05). See Table \\@ref(tab:traits) for trait abbreviations."}
mdata <- group_by(SES, strata, trait) %>% 
  mutate_at(c("Slope", "Curvature", "Wetness", "SW", "Canopy"), scale) %>% 
  group_by(strata, trait) %>% 
  do(mdata = list(N = nrow(.), K = 5, SES = .$SES, X = as.matrix(.[c("Slope", "Curvature", "Wetness", "SW", "Canopy")])))
fits <- lapply(mdata$mdata, function(m) sampling(lm, data = m))
names(fits) <- paste0(mdata$strata, "_", mdata$trait)
R2 <- lapply(fits, mcmc_intervals_data, regex_pars = "R2") %>% 
  bind_rows(.id = "model") %>% 
  separate(model, c("Guild", "Trait"), "_") %>% 
  mutate(R2 = m) %>% 
    mutate(Guild = recode(Guild, 
                           "U" = "Understory",
                           "C" = "Canopy")) %>% 
  dplyr::select(Guild, Trait, R2) %>% 
  mutate(Variable = "Canopy height", Significance = 1) %>% 
  mutate(R2 = paste0("R²=", round(R2, 2)))
lapply(fits, mcmc_intervals_data, regex_pars = "beta") %>% 
  bind_rows(.id = "model") %>% 
  separate(model, c("Guild", "Trait"), "_") %>% 
  mutate(Variable = recode(parameter, 
                           "beta[1]" = "Slope",
                           "beta[2]" = "Curvature",
                           "beta[3]" = "Wetness",
                           "beta[4]" = "Southwesterness",
                           "beta[5]" = "Canopy height")) %>% 
    mutate(Guild = recode(Guild, 
                           "U" = "Understory",
                           "C" = "Canopy")) %>% 
  mutate(Significance = 0) %>% 
  mutate(Significance = ifelse(m > 0 & ll > 0, 1, Significance)) %>% 
  mutate(Significance = ifelse(m < 0 & hh < 0, 1, Significance)) %>% 
  ggplot(aes(x = Variable, xend = Variable,
             color = Variable, fill = Variable,
             alpha = as.factor(Significance))) +
  geom_hline(yintercept = 0, color = "gray90", size = 1) +
  geom_hline(yintercept = c(-0.25, 0.25), 
             color = "gray90", size = 0.5, lty = "dashed") +
  geom_point(aes(y = m), shape = 21, size = 3) +
  geom_segment(aes(y = ll, yend = hh),
               size = 1, show.legend = F) +
  geom_segment(aes(y = l, yend = h), size = 2) +
  geom_text(y = -0.35, aes(label = R2), col = "black", data = R2) +
  coord_flip() +
  facet_grid(Trait ~ Guild, labeller = label_parsed, 
              scales = "free_y") +
  xaxis_title(F) +
  ylab("Standardised effect size") +
  scale_color_discrete(guide = "none") +
  scale_fill_discrete(guide = "none") +
  scale_alpha_manual(guide = "none", values = c(0.3, 1))
```

# Discussion

Few studies have investigated how the functional characteristics and composition of canopy and understorey guilds vary in tropical forests. 
We here show that functional trait values do not differ globally between canopy and understory tree species but that the contrasting environments between understory and canopy filter species non-randomly, 
resulting in a markedly different functional composition of canopy and understory guilds within subplots. 
We found that topography and canopy height significantly and differently impacts both canopy and understory guild assemblages.
Indeed, the functional composition of understory and canopy guilds assemblages respond similarly to water and nutrient access
but the functional composition of canopy guild communities strongly varies in response to wind exposure, 
and the functional variation of understory assemblages varies in response to light availability.
These results show that different environmental gradients simultaneously drive different functional responses among guilds in tropical rainforest.

## Decoupling of wood and leaf economics spectra at local scale

The PCA performed on species functional traits supported two orthogonal main dimensions (Fig. \@ref(fig:pca)).
SLA and LDMC were opposed into a dimension representing the leaf economics spectrum [@diaz_global_2015; @wright_worldwide_2004],
while, wood density was opposed to leaf area and thickness along a dimension previously interpreted as the wood economics spectrum  [@chave_towards_2009].
@Baraloto2010 and @Fortunel2012a also found orthogonal dimensions reflecting wood and leaf economic spectra of Neotropical tree species at regional scale in Amazonia.
In response to these works, @Messier2017 suggested that these two orthogonal spectra reflect large scale differences in tree functional composition and would not be observed among species co-occurring at a local scale. 
Here we captured the two orthogonal spectra across species at the scale of a 10 ha plot despite a limited number of traits compared to previous studies.  
Our results support that economics spectra are decoupled in tropical forests [@Baraloto2010] and not related to a single, whole-plant economics spectrum [@reich_world-wide_2014].

## Functional differences between canopy and understory guilds

We found that species pools of canopy and understory species broadly overlap in functional spaces, 
and both spanned a broad range of ecological strategies (Fig. \@ref(fig:pca)). 
However, we found significant trait differences between assemblages of canopy and understory species co-occuring in local 30 x 30m communities (Fig. \@ref(fig:GWMboxplot)).
Environmental conditions thus filtered species in local communities according to their trait, 
leading to highly contrasted functional compositions between canopy and understory guilds. 
Understory assemblages had larger, thinner and lighter leaves, hence greater SLA, 
and denser wood than canopy guild assemblages.
Greater hydraulic conduction is associated with lighter wood [@Santiago2018],
which is especially important for canopy species. 
The conservative leaf strategy observed in canopy assemblages may originate from two mechanisms. 
First, leaf water stress is expected to increase with tree height due to gravity [@Koch2004]
and to a higher water evaporation associated with sun and wind exposure [@Chazdon1993]. 
Second, a higher risk of herbivory exists in the canopy [@Sterck1992],
which may select for species resistant to herbivory with a more conservative strategy. 
Drought constraint could be less important for understory trees, 
allowing greater investment into resource acquisition by leaves to counterbalance the higher need for light in more shaded understory [@Chazdon1996]. 
However limited light may result in slower growth [@Herault2011] favoring denser wood. 
These results support the hypothesis that trees experience guild-specific ecological constraints within communities [@duque2002different], 
leading to contrasting functional compositions of canopy and understory assemblages. 

## Different responses to abiotic and biotic environment between canopy and understory assemblages

Our results show that the two guilds assemblages respond differently to some environmental gradients (Fig. \@ref(fig:LMres)). 
Curvature, wetness and slope similarly affected canopy and understory functional assemblages, except for LDMC. 
Locally convex wet, or flat areas tend to accumulate more soil, especially in hilly landscapes, and retain more water, increasing soil fertility [@ferry2010higher].
It thus creates favorable conditions where species with faster resource acquisition (higher SLA, and lower LDMC and LT) and growth (lower WD and higher LA) strategies outcompete others. 
By contrast, concave, drier or sloppy areas will be drier and less fertile favoring species assemblages with more conservative strategies and slower growth.

Contrary to understory assemblages, canopy assemblages respond to southwesterness, 
which face dominant monsoon winds in our study site, 
along the wood economics spectrum with a greater WD and smaller LA for higher southwesterness. 
The influence of aspect on tropical forest composition has been little documented. 
@gunatilleke_specieshabitat_2006 found significant influence of aspect on forest composition in a similar climatic and topographical context in Sri Lanka and also interpreted it as a consequence of a higher exposure to monsoon winds.
The Uppangala plot is characterized by a large topographic heterogeneity,
with steep slopes mostly organized along southwest-oriented crests (Fig. \@ref(fig:Uppangala)).
South-west oriented slopes are likely to be more exposed to monsoon winds,
which could entail greater tree damages and forest disturbance [@soman_aspects_1990]. 
The consequences could be that 
(i) tree strategies associated with mechanical resistance and disturbance tolerance could be selected in areas more exposed to monsoon wind damages [@Poorter2010b],
or (ii) turbulences on northeast oriented areas could yield more disturbance and death events favoring pioneer, lightwood species [@larjavaara_rethinking_2010]. 
In both cases, canopy species are more exposed to wind disturbances than understory trees and their functional composition is thus expected to respond more to wind exposure.

Conversely, we found pervasive influence of canopy height on the functional composition of understory assemblages related to leaf and wood economics, with increased acquisitive and growth strategies under tall canopies. 
We indeed found a greater investment into photosynthetic activity and growth, with higher SLA and lower LDMC, LT and WD, in understory assemblages under taller canopy. 
We expected canopy height to represent decreased light-availability contrasting with the observed functional strategies expected under increased access to light [@kitajima_tissue-level_2010]. 
As canopy height is as dynamic as individual recruitment of current species assemblages,
we hypothesized taller communities to result from more recent gaps with an increased abundance of acquisitive and fast growing post-pioneer species in understory.
This hypothesis needs to be thoroughly tested with growth or canopy time series.

## Conclusion

Our results show that functional variations among species and assemblages vary along the decoupled economic spectra of leaves and wood in an Indian rainforest.
We found a significant effect of topography and canopy height on the functional composition of tree communities, 
but also pointed out that these effects may be guild specific.
Our results argue in favour of decomposing the functional signature of community assemblage
in order to better characterize and understand the different strategies and responses of ecological guilds [@Raevel2018]
and the vertical structure of forests [@duque2002different]. 
We therefore call for a better recognition of the different dynamics of guilds within communities and their influence on the global functioning of forests.

# Acknowledgements

We would like to thank Cedric Vega for extending Uppangala plot to 10 ha. We also want to acknowledge the data cleaning operated by Arianne Tanguy. And we are thankful to Claire Fortunel for her comments.

# Authors’ contributions

SS, MRM, FM and VR conceived the study, designed the methodology and analysed model outputs; SS, FM, VR, NA, NB and NB conducted the field sampling; NA, NB and NB identified species; MRM and CSJ provided the environmental data; SS, MRM, FM and VR led the writing of the manuscript. All the authors contributed to the drafts and gave their final approval for publication.

# Data availability

Functional traits data have been submitted to TRY initiative [@Kattge2019] under the name UppangalaTraits. 
Environmental variables and spatial positions of individuals were extracted from the Uppangala Station database.
Access to LiDAR data is restricted by the Indian government and should be the object of a convention (contact: chandra.s.jha@gmail.com).

# References
